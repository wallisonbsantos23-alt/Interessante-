<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sorriso Detectado üíû</title>
  <meta name="theme-color" content="#0f0f12">
  <style>
    :root{--bg:#0f0f12;--card:#0b0b0d;--accent:#ff5c8a;color-scheme:dark}
    html,body{height:100%;margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:var(--bg);color:#fff}
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.6);max-width:420px;width:100%;text-align:center}
    video{width:100%;height:auto;border-radius:10px;background:#000;display:block;outline:1px solid rgba(255,255,255,0.03)}
    #msg{display:none;margin-top:12px;font-size:18px}
    #hint{font-size:14px;opacity:0.85;margin-top:6px}
    .small{font-size:13px;opacity:0.75;margin-top:6px}
    .btn{margin-top:10px;background:transparent;border:1px solid rgba(255,255,255,0.08);padding:8px 12px;border-radius:10px;color:#fff}
    canvas.confetti{position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;display:none;z-index:1000}
    footer{position:fixed;bottom:10px;left:0;right:0;text-align:center;font-size:12px;opacity:0.7}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Ative a c√¢mera e sorria üòÑ</h2>
      <video id="video" autoplay muted playsinline></video>
      <div id="hint" class="small">Carregando modelos... aguarde.</div>
      <div id="msg"><strong>Aten√ß√£o üö® Sorriso perigoso detectado.</strong><br>Extremamente viciante, <strong>Nathielle</strong> üòèüíû</div>
      <div id="fallback" style="margin-top:8px;display:none">
        <button id="manualBtn" class="btn">J√° sorri üòÑ (mostrar surpresa)</button>
        <button id="retryBtn" class="btn" style="margin-left:8px">Tentar novamente</button>
      </div>
    </div>
  </div>

  <canvas class="confetti" id="confetti"></canvas>
  <footer>Se o navegador pedir permiss√£o, permita o uso da c√¢mera. (Funciona melhor em HTTPS)</footer>

  <!-- face-api.js (peso pequeno) -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    // CONFIGURA√á√ïES
    const MODEL_URL = "https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/";
    const VIDEO = document.getElementById('video');
    const HINT = document.getElementById('hint');
    const MSG = document.getElementById('msg');
    const FALLBACK = document.getElementById('fallback');
    const MANUAL = document.getElementById('manualBtn');
    const RETRY = document.getElementById('retryBtn');
    const CONFETTI = document.getElementById('confetti');

    let stream = null;
    let detected = false;

    // Carrega os modelos necess√°rios
    async function loadModels(){
      try {
        HINT.textContent = 'Carregando modelos...';
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
        HINT.textContent = 'Modelos carregados ‚Äî abrindo c√¢mera...';
        await startCamera();
      } catch (e) {
        console.error(e);
        HINT.textContent = 'Erro ao carregar modelos. Verifique a conex√£o e tente novamente.';
        showFallbackButtons();
      }
    }

    async function startCamera(){
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        VIDEO.srcObject = stream;
        VIDEO.onloadedmetadata = () => VIDEO.play();
        HINT.textContent = 'Sorria naturalmente ‚Äî detectando...';
        detectSmileLoop();
      } catch (e) {
        console.error(e);
        HINT.textContent = 'Permita o acesso √† c√¢mera no navegador.';
        showFallbackButtons();
      }
    }

    // Loop de detec√ß√£o
    async function detectSmileLoop(){
      const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.5 });
      let attempts = 0;
      const maxAttempts = 120; // ~36s com interval 300ms
      const interval = 300;

      const timer = setInterval(async () => {
        if (detected) { clearInterval(timer); return; }
        if (VIDEO.readyState < 2) return;
        try {
          const result = await faceapi.detectSingleFace(VIDEO, options).withFaceExpressions();
          attempts++;
          if (result) {
            const happy = result.expressions?.happy || 0;
            // if confidence of "happy" is high enough -> trigger
            if (happy > 0.70) {
              detected = true;
              clearInterval(timer);
              revealMessage();
              return;
            }
          }
          if (attempts > maxAttempts) {
            clearInterval(timer);
            HINT.textContent = 'N√£o conseguimos detectar o sorriso automaticamente. Toque em "J√° sorri" ou "Tentar novamente".';
            showFallbackButtons();
          }
        } catch (err) {
          console.error(err);
        }
      }, interval);
    }

    // Mostrar mensagem e confete
    function revealMessage(){
      MSG.style.display = 'block';
      HINT.style.display = 'none';
      FALLBACK.style.display = 'none';
      startConfetti();
      stopCamera();
    }

    // Parar a c√¢mera
    function stopCamera(){
      try {
        if (stream) stream.getTracks().forEach(t => t.stop());
      } catch(e){}
    }

    // Mostrar bot√µes de fallback/manual
    function showFallbackButtons(){
      FALLBACK.style.display = 'block';
    }

    // Retry
    RETRY?.addEventListener('click', () => {
      // reset
      detected = false;
      MSG.style.display = 'none';
      HINT.style.display = 'block';
      HINT.textContent = 'Tentando novamente... sorria naturalmente.';
      FALLBACK.style.display = 'none';
      loadModels();
    });

    // Manual button for cases where auto-detection fails or user prefers
    MANUAL?.addEventListener('click', () => {
      detected = true;
      revealMessage();
    });

    // Confetti simple canvas animation
    function startConfetti(){
      CONFETTI.style.display = 'block';
      CONFETTI.width = innerWidth;
      CONFETTI.height = innerHeight;
      const ctx = CONFETTI.getContext('2d');
      const pieces = [];
      for (let i=0;i<120;i++){
        pieces.push({
          x: Math.random()*CONFETTI.width,
          y: Math.random()*-CONFETTI.height,
          r: Math.random()*6+4,
          s: Math.random()*2+1,
          c: ['#ff006e','#ffbe0b','#fb5607','#8338ec','#3a86ff'][Math.floor(Math.random()*5)],
          tilt: (Math.random()*0.8)-0.4
        });
      }
      let t = 0;
      (function draw(){
        ctx.clearRect(0,0,CONFETTI.width,CONFETTI.height);
        for (const p of pieces){
          ctx.fillStyle = p.c;
          ctx.beginPath();
          ctx.ellipse(p.x, p.y + Math.sin(t/10 + p.tilt*10)*6, p.r, p.r*0.6, p.tilt, 0, Math.PI*2);
          ctx.fill();
          p.y += p.s;
          p.x += Math.sin(t/20)*0.5;
          if (p.y > CONFETTI.height + 20){ p.y = -20; p.x = Math.random()*CONFETTI.width; }
        }
        t++;
        if (t < 700) requestAnimationFrame(draw);
        else CONFETTI.style.display = 'none';
      })();
    }

    // Iniciar tudo
    loadModels();
  </script>
</body>
</html>